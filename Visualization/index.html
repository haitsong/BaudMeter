<html ng-app="myApp">
  <head> 
    <!-- Include 3rd party libraries -->
    <script src="bower_components/d3/d3.js" charset="UTF-8"></script>
    <script src="bower_components/angular/angular.js" charset="UTF-8"></script>
    <script src="bower_components/angular-route/angular-route.js"></script>
    <script src="bower_components/topojson/topojson.js" charset="UTF-8"></script>

    <!-- Include the application files -->
    <script src="src/app.js"></script>
    <link href="src/app.css" rel="stylesheet">

    <!-- Include the files of the chart component -->
    <script src="src/services/eventService.js"></script>
    <script src="src/controller/latencyController.js"></script>
    <script src="src/controller/provinceLatencyViewController.js"></script>
    <script src="src/controller/traceRouteController.js"></script>
    <script src="src/controller/chinaTraceRouteViewController.js"></script>
    <script src="src/controller/traceQueryController.js"></script>


    <script src="src/views/provinceLatencyView.js"></script>
    <script src="src/views/chinaTraceRouteView.js"></script>
    <script src="src/controller/people.js"></script>
    <script src="src/controller/user.js"></script>

    // preloaded data of each Geolocation of GB1999: ChinaCountyGBZipLatLonArray
    <script src="src/data/ChinaCityCountyCodes.js" charset="UTF-8" ></script>
    // preload data: china map into: topoChinaMap;
    <script src="src/data/ChinaMapJs.js" charset="UTF-8" ></script>

    <script type="text/javascript" >

        /* INPUT PARAMETER, a function to return color for gb1999 */
        function GetCountyColor( gb1999OfCounty )
        {
          var colors  = ['#8ef','#fe8','#b8e','#8eb','#be8','#fbc','#cbf','#d8e','#e8d','#de8'];
          return colors[Math.floor(gb1999OfCounty/100%11)];
        }

        /* INPUT PARAMETER, a function to color and size of circle of each user site */
        function SetSiteCircleSizeAndColor(site)
        {
          var code= site.GB1999;
          var colorscale= d3.scale.linear().domain([0, 7000, 8000]).range(["green", "yellow", "red"]);
          site.color = colorscale(code%7*1000);
          site.radius = (code%11)*0.3;
        }

        var routeTraceMock={};

        /* INPUT PARAMETER, a function to return color for gb1999 */
        function GetRouteTrace(siteDetail, targetHost) {   //MOCK IMPL
          // this is an implementation on how this data is obtained.
          // { "origin" : "320100", "destination" : [ "350100"] , "value" : [ 853 ] },
          var key = 'GB' + siteDetail.gb1999;
          if (routeTraceMock[key]) {
            return routeTraceMock[key];
          }
          var res = [];
          var iinst = {"source": 'GB'+ siteDetail.gb1999, "target": null, "value": null};
          var nx = null;
          for (var i = 0; i < 100; i++) {
            var rx = Math.floor((Math.random() * 100) + 1);
            var rb = Math.floor((Math.random() * ChinaCountyGBZipLatLonArray.length));
            var gbx = ChinaCountyGBZipLatLonArray[rb];
            iinst.target= 'GB'+gbx.GB1999;
            iinst.value= rx;
            res.push(iinst);
            nx = (rx % 4 == 0 || i == 99)? iinst.target: key;
            iinst = {"source": nx, "target": null, "value": null};
          }
          routeTraceMock[key] = res;
          return res;
        }

        /*UTILITIES*/
        var activeProvince=0;
        var active_county=null;

        var chinaCountyCityDetail ={};

        function LoadGB1999CountyCenter(sites, projection) {
          sites = sites.forEach(function(site) {
            var location = [ site.LON ||site.longitude, site.LAT ||site.latitude];
            site.location = location; // wrap in geo location
            var pr =  projection(site.location);
            site.cx = pr[0];
            site.cy = pr[1];
            if(!site.GB1999) { // GB1999 should be computed before hand so that we know
              // what it belongs to.
              site.GB1999 = site.COUNTY|| site.ZHCITY || site.PROVINCE;
            }
            // create a map of geo locations;
            chinaCountyCityDetail["GB"+site.GB1999]=site;
          });
        };

        var arc = d3.geo.greatArc()
                .source(function(d) {
                  return chinaCountyCityDetail[d.source].location;
                })
                .target(function(d) {
                  return chinaCountyCityDetail[d.target].location;
                });

        // with the official GB1999 and location, we can map any gb1999 to lat lon;
        function FindMatchingGB1999Site(gb1999, nullallowed)
        {
          var s = "GB"+gb1999;
          var res = chinaCountyCityDetail[s];
          if(res || nullallowed) {
            return res;
          }
          return FindMatchingGB1999Site( Math.floor(gb1999/100.0) *100, true );
        }


    </script>

  </head>
  <body>
  <header>
    <a href="#/latency">Latency View</a>
    <a href="#/trace">Trace Route View</a>
    <a href='#/default'>Default</a>
  </header>
<div>
  <div id="countyname" >COUNTYNAME</div>
  <div id="provincename" >PROVNAME</div>
  <div id="cx" >cx</div>
  <div id="cy" >cy</div>
  <div id="zoomscale" >0</div>
</div>
  <svg id="svgcounties" width="900" height="600"><g id="gcounties"></g></svg>
  <div class="tooltip" style="opacity: 0; left: 504px; top: 810px;"></div>
  <div ng-view>
  </div>
  <!--

    <div ng-controller="peopleCtrl">
      <li ng-repeat="name in names">
        {{name}}
      </li>
    </div>

    <div ng-controller="userCtrl" align="left">
      <input ng-model="newUser"/>
      <button ng-click="addUser(newUser)">Add New User</button>
      <li ng-repeat="user in users">
        {{user}}
      </li>
    </div>
    -->

  </body> 
</html>